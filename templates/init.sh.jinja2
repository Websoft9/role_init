#!/bin/bash
new_password=$(pwgen -ncCs 10 1)
{% if (init_db is defined ) and (init_db != None) %}
{% for db_names,dbs in init_db.items() %}
systemctl start {{db_names}}
{% if db_names == 'mysql' or db_names == 'mariadb' %}
mysqladmin -u{{dbs.user}} -p{{dbs.password }} password $new_password
{% if (init_application is defined) and (init_application != none) %}
mysqladmin -u{{init_application.application_database_user}} -p{{init_application.application_database_password}} password $new_password
{% endif %}
{% endif %}

{% if db_names == 'postgrepsql' %}
echo "               
ALTER USER {{dbs.user}} WITH PASSWORD '$new_password';
" | sudo -u {{dbs.user}} psql
{% if (init_application is defined) and (init_application != none) %}
echo "               
ALTER USER {{init_application.application_database_user}} WITH PASSWORD '$new_password';
" | sudo -u {{dbs.user}} psql
{% endif %}
{% endif %}

{% if db_names == 'mongodb' %}
sleep 10
echo "
use admin
db.changeUserPassword('{{dbs.user}}','$new_password')
" | mongo -u {{dbs.user}} -p {{dbs.password}}
{% if (init_application is defined) and (init_application != none) %}
echo "
use admin
db.changeUserPassword('{{init_application.application_database_user}}','$new_password')
" | mongo -u {{dbs.user}} -p {{dbs.password}}
{% endif %}
{% endif %}
sed -i "s/{{dbs.password}}/$new_password/g" /credentials/password.txt

{% if (init_application.application_config_path is defined) and  (init_application.application_config_path != none) %}
{% for path in init_application.application_config_path %}
sed -i "s/{{init_application.application_database_password}}/$new_password/" {{path}}
{% endfor %}
{% endif %}

{% if (init_application.application_service is defined) and  (init_application.application_service != none) %}
{% if init_application.application_service != none %}
systemctl restart {{init_application.application_service}}
{% endif %}
{% endif %}

{% if (init_application.application_random_password is defined) and  (init_application.application_random_password != none) and (init_application.application_random_password_method is defined) and  (init_application.application_random_password_method != none) %}
{% if init_application.application_random_password  %}
{% for method in  init_application.application_random_password_method %}}
{{method}}
{% endfor %}
{% endif %}
{% endif %}
sed -i 's/\/root\/init.sh//g' /etc/rc.local
rm -rf /root/init.sh
{% endfor %}
{% endif %}